name: Review GitHub Actions Workflows

on:
  pull_request:
    paths:
      - '.github/workflows/**'
    paths-ignore:
      - '.github/workflows/self-review.yml'
      - '.github/workflows/review-workflows.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  review-workflows:
    name: Review Workflow Changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    # Only run on pull_request events, not push events
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Generate GitHub App Token
        id: app-token
        if: vars.APP_ID != ''
        uses: actions/create-github-app-token@bf559f85448f9380bcfa2899dbdc01eb5b37be3a # v3.0.0-beta.2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Get Changed Workflow Files
        id: changed-files
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const workflowFiles = files
              .filter(f => f.status === 'modified' || f.status === 'added' || f.status === 'renamed')
              .filter(f => f.filename.match(/^\.github\/workflows\/.*\.ya?ml$/))
              .filter(f => !f.filename.match(/\/(self-review|review-workflows)\.yml$/))
              .map(f => f.filename);

            core.setOutput('files', JSON.stringify(workflowFiles));
            core.setOutput('count', workflowFiles.length.toString());
            console.log(`Found ${workflowFiles.length} workflow files to review`);

      - name: Run GitHub Actions Reviewer
        if: steps.changed-files.outputs.count != '0'
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-app-token: ${{ steps.app-token.outputs.token }}
          changed-files: ${{ steps.changed-files.outputs.files }}
          # Use multiple skills: local GitHub Actions reviewer + built-in PR toolkit
          skills: '["github-actions-reviewer", "builtin:pr-review-toolkit"]'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude-args: '--dangerously-skip-permissions'
          settings: '{"env": {"ANTHROPIC_BASE_URL": "https://api.z.ai/api/anthropic"}}'
