# Unit test workflow for act - tests action setup without external API calls
# This validates the basic mechanics work locally
#
# Usage:
#   act -j test-unit

name: Unit Test (act only)

on:
  workflow_dispatch:

jobs:
  test-unit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Cache uv
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.local/bin/uv
            ~/.local/share/uv
            ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Cache Python
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.local/share/uv/python
          key: ${{ runner.os }}-python-3.13
          restore-keys: |
            ${{ runner.os }}-python-

      - name: Setup Python (test action step)
        shell: bash
        run: |
          echo "Testing Python setup from action..."
          if ! command -v uv &> /dev/null; then
            echo "Installing uv..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
          fi
          # uv installs to $HOME/.local/bin by default
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          uv --version
          uv python install 3.13

      - name: Verify project structure
        shell: bash
        run: |
          echo "Verifying project structure..."
          export PATH="$HOME/.local/bin:$PATH"
          test -f action/action.yml && echo "✓ action/action.yml exists"
          test -f pyproject.toml && echo "✓ pyproject.toml exists"
          test -d src/cletus_code && echo "✓ src/cletus_code exists"
          ls -la src/cletus_code/*.py

      - name: Test import (basic smoke test)
        shell: bash
        run: |
          echo "Testing Python imports..."
          export PATH="$HOME/.local/bin:$PATH"
          uv run --python 3.13 python -c "
          import sys
          sys.path.insert(0, 'src')
          from cletus_code import config, utils
          print('✓ Imports successful')
          "

      - name: Test CLI entry point
        shell: bash
        run: |
          echo "Testing CLI entry point..."
          export PATH="$HOME/.local/bin:$PATH"
          uv run --python 3.13 -m cletus_code --help || echo "Expected: no arguments provided"

      - name: Summary
        run: |
          echo "## Unit Test Results ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Python setup: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- Project structure: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- Python imports: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- CLI entry point: ✓" >> $GITHUB_STEP_SUMMARY
